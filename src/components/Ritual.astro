---
const {
  id
} = Astro.props;

if (!id) {
  throw new Error("Ritual requires an id.");
}
---

<section id={id} class="ritual" data-ritual>
  <div class="ritual-body">
    <slot />
  </div>
</section>

<style>

  .ritual {
    margin-bottom: var(--space-8);

    opacity: 0;
    transform: translateY(30px);

    transition:
      opacity .9s ease,
      transform .9s ease;
  }

  .ritual.is-visible {
    opacity: 1;
    transform: translateY(0);
  }

  .ritual-body p {
    margin-bottom: var(--space-3);
  }

  @media (max-width: 768px) {
    .ritual {
      margin-bottom: var(--space-7);
    }
  }

  @media (hover: none), (pointer: coarse) {
    .ritual {
      opacity: 1;
      transform: none;
      transition: none;
    }
  }

</style>

<script>
  (() => {
    const rituals = Array.from(document.querySelectorAll("[data-ritual]"));

    if (!rituals.length) return;

    const timeline = document.getElementById("timeline");
    const timelineItems = new Map(
      Array.from(document.querySelectorAll(".timeline-item"))
        .map(el => [el.dataset.id, el])
    );

    /* ========================= */
    /* VISIBILITY ANIMATION      */
    /* ========================= */ 

    const observer = new IntersectionObserver(
      entries => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add("is-visible");
          }
        });
      },
      {
        threshold: 0.15,
        rootMargin: "0px 0px -10% 0px"
      }
    );

    rituals.forEach(r => observer.observe(r));

    /* ========================= */
    /* TIMELINE ACTIVE STATE     */
    /* ========================= */

    let ticking = false;

    function updateActive() {
      const vh = window.innerHeight;
      let activeId = null;

      for (const ritual of rituals) {
        const rect = ritual.getBoundingClientRect();
        const visible =
          Math.min(rect.bottom, vh) - Math.max(rect.top, 0);

        const ratio = visible / vh;

        if (ratio >= 0.5) {
          activeId = ritual.id;
          break;
        }
      }

      timelineItems.forEach(el =>
        el.classList.toggle("active", el.dataset.id === activeId)
      );

      if (timeline) {
        timeline.classList.toggle("visible", !!activeId);
      }

      ticking = false;
    }

    function onScroll() {
      if (!ticking) {
        requestAnimationFrame(updateActive);
        ticking = true;
      }
    }

    window.addEventListener("scroll", onScroll, { passive: true });
    window.addEventListener("resize", onScroll);

    updateActive();
  })();
</script>
