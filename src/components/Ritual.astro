---
import RitualHeader from "./RitualHeader.astro";

const { 
  id
} = Astro.props;

if (!id) {
  throw new Error("Ritual requires an id.");
}
---

<section id={id} class="ritual" data-ritual>
  <div class="ritual-body">
    <slot />
  </div>
</section>

<style>

/* ================================================= */
/* SECTION ROOT                                      */
/* ================================================= */

.ritual {
  margin-bottom: var(--space-8);

  opacity: 0;
  transform: translateY(30px);
  transition:
    opacity 1s ease,
    transform 1s ease;
}

.ritual.is-visible {
  opacity: 1;
  transform: translateY(0);
}

/* ================================================= */
/* BODY                                              */
/* ================================================= */

.ritual-body {
  opacity: 0;
  transition: opacity 1.2s ease 0.2s;
}

.ritual.is-visible .ritual-body {
  opacity: 1;
}

.ritual-body p {
  margin-bottom: var(--space-3);
}

/* ================================================= */
/* RESPONSIVE                                        */
/* ================================================= */

@media (max-width: 768px) {
  .ritual {
    margin-bottom: var(--space-7);
  }
}

</style>

<script>
  const rituals = document.querySelectorAll("[data-ritual]");
  const timeline = document.getElementById("timeline");
  const timelineItems = document.querySelectorAll(".timeline-item");

  const animationObserver = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          entry.target.classList.add("is-visible");
        }
      });
    },
    {
      threshold: 0.15,
      rootMargin: "0px 0px -10% 0px",
    }
  );

  rituals.forEach((ritual) => animationObserver.observe(ritual));

  function updateActiveRitual() {
    let activeFound = false;
    const viewportHeight = window.innerHeight;

    rituals.forEach((ritual) => {
      const rect = ritual.getBoundingClientRect();

      const visibleHeight =
        Math.min(rect.bottom, viewportHeight) -
        Math.max(rect.top, 0);

      const viewportRatio = visibleHeight / viewportHeight;

      const timelineLink = document.querySelector(
        `.timeline-item[data-id="${ritual.id}"]`
      );

      if (viewportRatio >= 0.5) {
        activeFound = true;

        timelineItems.forEach(item =>
          item.classList.remove("active")
        );

        timelineLink?.classList.add("active");
      }
    });

    if (timeline) {
      timeline.classList.toggle("visible", activeFound);
    }
  }

  window.addEventListener("scroll", updateActiveRitual);
  window.addEventListener("resize", updateActiveRitual);

  updateActiveRitual();
</script>
